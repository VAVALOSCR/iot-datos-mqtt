<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Producci√≥n (MQTT)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; background:#f6f7fb; color:#222; }
    h1 { color:#0b5ed7; }
    .card { background:white; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:12px; max-width:900px; }
    .grid { display:flex; gap:12px; flex-wrap:wrap; }
    .small { flex:1 1 200px; }
    canvas { max-width:900px; margin:10px auto; display:block; }
  </style>
</head>
<body>
  <h1>üì° Dashboard de Producci√≥n (MQTT)</h1>

  <div class="card">
    <strong>Broker:</strong> gatoo.cloud.shiftr.io &nbsp;&nbsp; <strong>User:</strong> gatoo
    <div id="status">Conectando...</div>
  </div>

  <div id="info" class="card">Esperando datos...</div>

  <div class="card">
    <div class="grid">
      <div class="small"><canvas id="barChart"></canvas></div>
      <div class="small"><canvas id="pieChart"></canvas></div>
    </div>
  </div>

  <script>
    // Configura aqu√≠ (no recomendable guardar claves en repos p√∫blicos)
    const BROKER_WS = "wss://gatoo.cloud.shiftr.io:443"; // probar wss
    const USER = "gatoo";
    const PASS = "hola";
    const TOPIC_STATUS = "factory/status";
    const TOPIC_EVENTS = "factory/events";

    const client = mqtt.connect(BROKER_WS, {
      username: USER,
      password: PASS,
      reconnectPeriod: 3000
    });

    const infoDiv = document.getElementById("info");
    const statusDiv = document.getElementById("status");

    let latestState = null;

    client.on("connect", () => {
      statusDiv.innerText = "Conectado al broker MQTT";
      client.subscribe(TOPIC_STATUS);
      client.subscribe(TOPIC_EVENTS);
    });

    client.on("reconnect", () => statusDiv.innerText = "Reconectando...");
    client.on("offline", () => statusDiv.innerText = "Offline");
    client.on("error", (err) => { statusDiv.innerText = "Error: " + err; console.error(err); });

    client.on("message", (topic, message) => {
      try {
        const payload = JSON.parse(message.toString());
        if (topic === TOPIC_STATUS) {
          latestState = payload;
          renderInfo(payload);
          renderCharts(payload);
        } else if (topic === TOPIC_EVENTS) {
          // podr√≠amos mostrar un log o animaci√≥n
          console.log("EVENT:", payload);
        }
      } catch(e) {
        console.error("No JSON:", message.toString());
      }
    });

    function renderInfo(s) {
      if (!s) { infoDiv.innerHTML = "Sin datos"; return; }
      infoDiv.innerHTML = `
        <h3>${s.producto || "Producto"}</h3>
        <p><b>Empleados:</b> ${s.empleados || 0} &nbsp; <b>M√°q. activas:</b> ${s.maquinas_activas || 0}</p>
        <p><b>Producci√≥n d√≠a/mes:</b> ${s.produccion_dia || 0} / ${s.produccion_mes || 0}</p>
        <p><b>Producci√≥n por turno:</b> ${JSON.stringify(s.produccion_por_turno || {})}</p>
        <p><b>Defectuosas:</b> ${s.defectuosas || 0} &nbsp; <b>Insumos %:</b> ${s.insumos_porcentaje || 0}%</p>
        <p><b>Meta mes:</b> ${s.meta_mes || 0} &nbsp; <b>Ganancias:</b> S/ ${s.ganancias || 0}</p>
        <p><b>Comparaci√≥n mes anterior:</b> ${s.comparacion_mes_anterior || 0}%</p>
        <p><b>Tiempo actividad m√°quinas (hs):</b> ${s.tiempo_actividad_maquina_hs || s.tiempo_actividad_maquina || 0}</p>
        <p><b>Recomendaciones:</b> ${s.recomendaciones || "‚Äî"}</p>
        <p><b>Especificaciones:</b> ${s.especificaciones || "‚Äî"}</p>
        <p><small>√öltima lectura: ${s.timestamp || ""}</small></p>
      `;
    }

    // Chart.js
    let barChart = null;
    let pieChart = null;

    function renderCharts(s) {
      // Datos m√°quinas
      const machines = [s.maquinas_activas || 0, s.maquinas_inactivas || 0, s.maquinas_mantenimiento || 0];

      // Barra
      const barCtx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: ['Activas','Inactivas','Mantenimiento'],
          datasets: [{ label: 'M√°quinas', data: machines }]
        },
        options: { responsive: true }
      });

      // Pastel: buena vs defectuosa
      const good = (s.produccion_mes || 0) - (s.defectuosas || 0);
      const bad = s.defectuosas || 0;
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: ['Buena', 'Defectuosa'],
          datasets: [{ data: [Math.max(0, good), Math.max(0, bad)] }]
        },
        options: { responsive: true }
      });
    }

    // refrescar UI si hay estado existente
    setInterval(() => {
      if (latestState) renderInfo(latestState);
    }, 5000);

  </script>
</body>
</html>
