<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Simulador Motores con Serial</title>

<style>

body{
    font-family: Arial;
    background:#ecf3f9;
    text-align:center;
}

/* ROBOT */

#robot{
    width:650px;
    height:280px;
    background:yellow;
    margin:auto;
    border:2px solid black;
    position:relative;
}

.motor{
    width:80px;
    position:absolute;
    top:140px;
}

#motorA{ left:120px; }
#motorB{ right:120px; }

/* SENSOR */

#sensor{
    position:absolute;
    left:50%;
    top:20px;
    transform:translateX(-50%);
    width:180px;
}

.flecha{
    font-size:80px;
    position:absolute;
    top:-50px;
    width:100%;
}

/* ANIMACIONES */

@keyframes parpadeo {
    0% { opacity:1; }
    50% { opacity:0.2; }
    100% { opacity:1; }
}

@keyframes moverLados {
    0% { transform:translateX(0); }
    50% { transform:translateX(12px); }
    100% { transform:translateX(0); }
}

.anim-vertical{
    animation: parpadeo 0.6s infinite;
}

.anim-horizontal{
    animation: moverLados 0.6s infinite;
}

/* LEDS */

.led{
    width:22px;
    height:22px;
    border-radius:50%;
    background:gray;
    display:inline-block;
    margin:5px;
    border:1px solid black;
}

.on{
    background:lime;
}

/* CONTROLES */

input{
    width:60px;
    text-align:center;
    font-size:16px;
}

button{
    padding:8px 12px;
    margin:5px;
    font-size:14px;
    cursor:pointer;
}

.box{
    background:white;
    border:1px solid #aaa;
    margin:10px;
    padding:10px;
}

.alerta{
    color:red;
    font-weight:bold;
    font-size:18px;
}

</style>
</head>

<body>

<h1>SIMULADOR MOTORES CON SERIAL WEB</h1>

<!-- ROBOT -->

<div id="robot">

    <div id="motorA" class="motor">
        <div class="flecha" id="fa"></div>
        <img src="motor.png" width="80">
    </div>

    <!-- SENSOR -->
    <img src="sensor.png" id="sensor">

    <div id="motorB" class="motor">
        <div class="flecha" id="fb"></div>
        <img src="motor.png" width="80">
    </div>

</div>

<!-- SENSOR DATOS -->

<div class="box">

<h3>Sensor de Distancia</h3>

Distancia:
<span id="distancia">--</span> cm

&nbsp;&nbsp;

Umbral:
<input type="number" id="umbral" min="0" max="50" value="20">

<p id="alerta"></p>

</div>

<!-- LEDS -->

<div class="box">

<h3>LEDs</h3>

Motor A:
<span id="A1" class="led"></span>
<span id="A2" class="led"></span>

&nbsp;&nbsp;

Motor B:
<span id="B1" class="led"></span>
<span id="B2" class="led"></span>

</div>

<!-- ENTRADAS -->

<div class="box">

<h3>Entradas</h3>

Motor A:
<input id="eA">

Motor B:
<input id="eB">

<button onclick="simular()">Simular</button>

</div>

<!-- ASIGNAR -->

<div class="box">

<h3>Asignar Caracteres</h3>

Adelante <input id="cA" value="F">
Atr√°s <input id="cB" value="B">
Derecha <input id="cR" value="R">
Izquierda <input id="cL" value="L">
STOP <input id="cS" value="S">

</div>

<!-- SERIAL -->

<div class="box">

<h3>Puerto Serial</h3>

<button onclick="conectar()">üîå Conectar Arduino</button>
<span id="estado">No conectado</span>

</div>

<!-- BOTONES -->

<div class="box">

<h3>Control</h3>

<button onclick="cmd('A')">‚¨Ü Adelante</button>
<button onclick="cmd('B')">‚¨á Atr√°s</button>
<button onclick="cmd('R')">‚û° Derecha</button>
<button onclick="cmd('L')">‚¨Ö Izquierda</button>
<button onclick="cmd('S')">‚èπ STOP</button>

</div>

<!-- LINK TINKERCAD -->

<div class="box">

<h3>Simulaci√≥n en Tinkercad</h3>

<button onclick="window.open('https://www.tinkercad.com/things/g3AKvdZcFHZ-carrito-inicios?sharecode=XT6kGfbR9SjYC7Qi1wHHKrMoH2SAsh9SB8Aw7_1RkYY','_blank')">
üåê Abrir Proyecto en Tinkercad
</button>

</div>

<p id="msg" style="font-size:18px;font-weight:bold;"></p>

<script>

/* ================= SERIAL ================= */

let port;
let writer;
let conectado = false;

/* ================= SENSOR ================= */

let distanciaActual = 30;
let detenidoAuto = false;

/* ================= SONIDOS ================= */

const audioAdelante = new Audio("adelante.mp3");
const audioAtras = new Audio("atras.mp3");
const audioDerecha = new Audio("derecha.mp3");
const audioIzquierda = new Audio("izquierda.mp3");
const audioStop = new Audio("stop.mp3");

function reproducir(a){
    a.currentTime = 0;
    a.play();
}

/* ================= CONECTAR ================= */

async function conectar(){

    try{

        port = await navigator.serial.requestPort();
        await port.open({ baudRate:9600 });

        writer = port.writable.getWriter();

        conectado = true;

        estado.innerText = "Conectado";

        leerSerial();

    }catch(e){

        alert("No se pudo conectar");

    }
}

/* ================= LEER SERIAL ================= */

async function leerSerial(){

    const reader = port.readable.getReader();
    let buffer = "";

    while(true){

        const { value, done } = await reader.read();

        if(done) break;

        buffer += new TextDecoder().decode(value);

        if(buffer.includes("\n")){

            let linea = buffer.trim();
            buffer="";

            procesarDato(linea);
        }
    }
}

/* ================= PROCESAR SENSOR ================= */

function procesarDato(txt){

    let d = parseInt(txt);

    if(isNaN(d)) return;

    distanciaActual = d;

    distancia.innerText = d;

    verificarUmbral();
}

/* ================= VERIFICAR ================= */

async function verificarUmbral(){

    let um = parseInt(umbral.value);

    if(isNaN(um)) return;

    if(um<0) um=0;
    if(um>50) um=50;

    umbral.value = um;

    if(distanciaActual < um){

        if(!detenidoAuto){

            detenidoAuto = true;

            alerta.innerHTML = "üö® OBST√ÅCULO DETECTADO - PARAR";
            alerta.className="alerta";

            await cmd("S");
        }

    }else{

        detenidoAuto = false;

        alerta.innerHTML = "";
    }
}

/* ================= ENVIAR ================= */

async function enviarSerial(txt){

    if(!conectado) return;

    const data = new TextEncoder().encode(txt+"\n");

    await writer.write(data);
}

/* ================= LED ================= */

function led(id,val){

    document.getElementById(id)
    .classList.toggle("on", val=="1");
}

/* ================= FLECHA ================= */

function flecha(id,val){

    let f="";

    if(val=="10") f="‚¨Ü";
    if(val=="01") f="‚¨á";

    document.getElementById(id).innerHTML = f;
}

/* ================= APLICAR ================= */

function aplicar(a,b){

    fa.className = "flecha";
    fb.className = "flecha";

    led("A1",a[0]);
    led("A2",a[1]);

    led("B1",b[0]);
    led("B2",b[1]);

    flecha("fa",a);
    flecha("fb",b);

    let t="";

    if(a=="10" && b=="10"){
        t="‚¨Ü ADELANTE";
        fa.classList.add("anim-vertical");
        fb.classList.add("anim-vertical");
        reproducir(audioAdelante);
    }

    else if(a=="01" && b=="01"){
        t="‚¨á ATR√ÅS";
        fa.classList.add("anim-vertical");
        fb.classList.add("anim-vertical");
        reproducir(audioAtras);
    }

    else if(a=="10" && b=="00"){
        t="‚û° DERECHA";
        fa.classList.add("anim-horizontal");
        fb.classList.add("anim-horizontal");
        reproducir(audioDerecha);
    }

    else if(a=="00" && b=="10"){
        t="‚¨Ö IZQUIERDA";
        fa.classList.add("anim-horizontal");
        fb.classList.add("anim-horizontal");
        reproducir(audioIzquierda);
    }

    else if(a=="00" && b=="00"){
        t="‚èπ STOP";
        reproducir(audioStop);
    }

    else{
        t="‚Üï MIXTO";
    }

    msg.innerText = t;
}

/* ================= SIMULAR ================= */

function simular(){

    let a = eA.value;
    let b = eB.value;

    if(!["00","01","10"].includes(a)
    || !["00","01","10"].includes(b)){

        alert("Use: 00, 01 o 10");
        return;
    }

    aplicar(a,b);
}

/* ================= COMANDOS ================= */

async function cmd(c){

    let a="", b="", letra="";

    if(c=="A"){ a="10"; b="10"; letra=cA.value; }
    if(c=="B"){ a="01"; b="01"; letra=cB.value; }
    if(c=="R"){ a="10"; b="00"; letra=cR.value; }
    if(c=="L"){ a="00"; b="10"; letra=cL.value; }
    if(c=="S"){ a="00"; b="00"; letra=cS.value; }

    eA.value = a;
    eB.value = b;

    aplicar(a,b);

    await enviarSerial(letra);

    msg.innerText += conectado
        ? " | Enviado: " + letra
        : " | (No conectado)";
}

</script>

</body>
</html>
