<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IoT Dashboard + Control</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f3f3f3; }
        h1 { color: #007BFF; }
        .dato { font-size: 1.2em; margin: 5px 0; }
        .reles button {
            margin: 4px;
            padding: 10px 20px;
            font-size: 1em;
        }
    </style>
</head>
<body>
    <h1>Dashboard IoT - MARIATEGUI</h1>

    <h2>📊 Datos del Sensor</h2>
    <p class="dato">🌡️ Temperatura: <span id="temp">--</span> °C</p>
    <p class="dato">💧 Humedad: <span id="hum">--</span> %</p>
    <p class="dato">🧪 Gas (valor): <span id="gas_valor">--</span></p>
    <p class="dato">🚨 Alerta Gas: <span id="gas_alerta">--</span></p>
    <p class="dato">🚶 Movimiento: <span id="mov">--</span></p>

    <h2>🎮 Control de Relés</h2>
    <div class="reles">
        <button onclick="controlRele(1, true)">RELE 1 ON</button>
        <button onclick="controlRele(1, false)">RELE 1 OFF</button>
        <button onclick="controlRele(2, true)">RELE 2 ON</button>
        <button onclick="controlRele(2, false)">RELE 2 OFF</button>
        <button onclick="controlRele(3, true)">RELE 3 ON</button>
        <button onclick="controlRele(3, false)">RELE 3 OFF</button>
        <button onclick="controlRele(4, true)">RELE 4 ON</button>
        <button onclick="controlRele(4, false)">RELE 4 OFF</button>
    </div>

    <script>
        const broker = "wss://datos.cloud.shiftr.io:443";
        const options = {
            username: "datos",
            password: "hola"
        };

        const client = mqtt.connect(broker, options);

        client.on("connect", () => {
            console.log("Conectado a Shiftr.io");
            client.subscribe("sensor/datos");
        });

        client.on("message", (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                document.getElementById("temp").textContent = data.temperatura;
                document.getElementById("hum").textContent = data.humedad;
                document.getElementById("gas_valor").textContent = data.gas_valor;
                document.getElementById("gas_alerta").textContent = data.gas_alerta === 1 ? "Sí" : "No";
                document.getElementById("mov").textContent = data.movimiento === 1 ? "Sí" : "No";
            } catch (e) {
                console.error("Error al parsear mensaje:", e);
            }
        });

        function controlRele(numero, encender) {
            const comando = `RELE${numero}_${encender ? "ON" : "OFF"}`;
            client.publish("sensor/control", comando);
            console.log("Comando enviado:", comando);
        }
    </script>
</body>
</html>
