<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>IoT Dashboard + Control</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f3f3f3; }
        h1 { color: #007BFF; }
        .dato { font-size: 1.2em; margin: 5px 0; }
        .reles button, .auto-btn {
            margin: 4px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
        }
        .auto-btn {
            background-color: #28a745;
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <h1>Dashboard IoT - MARIATEGUI</h1>

    <h2>üìä Datos del Sensor</h2>
    <p class="dato">üå°Ô∏è Temperatura: <span id="temp">--</span> ¬∞C</p>
    <p class="dato">üíß Humedad: <span id="hum">--</span> %</p>
    <p class="dato">üß™ Gas (valor): <span id="gas_valor">--</span></p>
    <p class="dato">üö® Alerta Gas: <span id="gas_alerta">--</span></p>
    <p class="dato">üö∂ Movimiento: <span id="mov">--</span></p>
    <p class="dato">üîå Corriente: <span id="corriente">--</span> mA</p>

    <h2>üéÆ Control de Rel√©s</h2>
    <div class="reles">
        <button onclick="controlRele(1, true)">RELE 1 ON</button>
        <button onclick="controlRele(1, false)">RELE 1 OFF</button>
        <button onclick="controlRele(2, true)">RELE 2 ON</button>
        <button onclick="controlRele(2, false)">RELE 2 OFF</button>
        <button onclick="controlRele(3, true)">RELE 3 ON</button>
        <button onclick="controlRele(3, false)">RELE 3 OFF</button>
        <button onclick="controlRele(4, true)">RELE 4 ON</button>
        <button onclick="controlRele(4, false)">RELE 4 OFF</button>
    </div>

    <h2>ü§ñ Modos Autom√°ticos</h2>
    <p class="dato">üü¢ PIR Autom√°tico: <span id="estadoPIR">Desactivado</span></p>
    <p class="dato">üí° Luz Autom√°tica: <span id="estadoLuz">Desactivado</span></p>
    <button class="auto-btn" onclick="activarAuto('AUTO_PIR')">Activar Modo PIR</button>
    <button class="auto-btn" onclick="activarAuto('AUTO_LUZ')">Activar Modo Luz</button>
    <button class="auto-btn" onclick="desactivarAuto()">Desactivar Modo Autom√°tico</button>

    <script>
        const broker = "wss://datos.cloud.shiftr.io:443";
        const options = {
            username: "datos",
            password: "hola"
        };

        const client = mqtt.connect(broker, options);

        let modoPIR = false;
        let modoLuz = false;

        client.on("connect", () => {
            console.log("Conectado a Shiftr.io");
            client.subscribe("sensor/datos");
            client.subscribe("sensor/control");  // Para recibir comandos externos
        });

        client.on("message", (topic, message) => {
            const msg = message.toString();
            if (topic === "sensor/datos") {
                try {
                    const data = JSON.parse(msg);
                    document.getElementById("temp").textContent = data.temperatura;
                    document.getElementById("hum").textContent = data.humedad;
                    document.getElementById("gas_valor").textContent = data.gas_valor;
                    document.getElementById("gas_alerta").textContent = data.gas_alerta === 1 ? "S√≠" : "No";
                    document.getElementById("mov").textContent = data.movimiento === 1 ? "S√≠" : "No";
                    document.getElementById("corriente").textContent = data.corriente || "--";
                } catch (e) {
                    console.error("Error al parsear mensaje:", e);
                }
            } else if (topic === "sensor/control") {
                if (msg === "AUTO_PIR") {
                    modoPIR = true;
                    modoLuz = false;
                    updateEstadoModos();
                } else if (msg === "AUTO_LUZ") {
                    modoPIR = false;
                    modoLuz = true;
                    updateEstadoModos();
                } else if (msg === "AUTO_OFF") {
                    modoPIR = false;
                    modoLuz = false;
                    updateEstadoModos();
                }
            }
        });

        function controlRele(numero, encender) {
            modoPIR = false;
            modoLuz = false;
            updateEstadoModos();
            const comando = `RELE${numero}_${encender ? "ON" : "OFF"}`;
            client.publish("sensor/control", comando);
            console.log("Comando enviado:", comando);
        }

        function activarAuto(tipo) {
            client.publish("sensor/control", tipo);
            console.log("Comando enviado:", tipo);
        }

        function desactivarAuto() {
            client.publish("sensor/control", "AUTO_OFF");
            console.log("Comando enviado: AUTO_OFF");
        }

        function updateEstadoModos() {
            document.getElementById("estadoPIR").textContent = modoPIR ? "Activado" : "Desactivado";
            document.getElementById("estadoLuz").textContent = modoLuz ? "Activado" : "Desactivado";
        }
    </script>
</body>
</html>
