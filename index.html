<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Simulador Motores DC</title>

<style>

body{
    font-family:Arial;
    background:#ECF3F9;
    text-align:center;
}

/* ROBOT */

#robot{
    width:650px;
    height:280px;
    background:white;
    margin:auto;
    border:2px solid black;
    position:relative;
}

/* MOTORES */

.motor{
    width:110px;
    position:absolute;
    top:120px;
}

#mA{ left:120px; }
#mB{ right:120px; }

/* FLECHAS (CSS) */

.flecha{
    font-size:45px;
    font-weight:bold;
    position:absolute;
    top:30px;
    color:#3498DB;
}

#fA{ left:150px; }
#fB{ right:150px; }

/* LEDS */

.led{
    width:22px;
    height:22px;
    border-radius:50%;
    background:gray;
    display:inline-block;
    margin:8px;
    border:1px solid black;
}

/* PANEL */

input{
    width:55px;
    font-size:18px;
    text-align:center;
}

button{
    padding:10px;
    margin:5px;
    font-size:15px;
    cursor:pointer;
}

#msg{
    font-size:20px;
    font-weight:bold;
    margin:15px;
}

/* SERIAL */

#serial{
    background:#D6EAF8;
    padding:10px;
    margin:10px;
}

</style>
</head>

<body>

<h1>SIMULADOR DIDÁCTICO DE MOTORES DC</h1>

<!-- ROBOT -->

<div id="robot">

    <img src="motor.png" class="motor" id="mA">
    <img src="motor.png" class="motor" id="mB">

    <div class="flecha" id="fA">■</div>
    <div class="flecha" id="fB">■</div>

</div>

<!-- LEDS -->

<div>

IN1 <div class="led" id="A1"></div>
IN2 <div class="led" id="A2"></div>

&nbsp;&nbsp;

IN3 <div class="led" id="B1"></div>
IN4 <div class="led" id="B2"></div>

</div>

<!-- ENTRADAS -->

<div>

Motor A:
<input id="inA" value="00">

Motor B:
<input id="inB" value="00">

<button onclick="simular()">SIMULAR</button>

</div>

<!-- CONTROLES -->

<div>

<button onclick="mover('ADELANTE')">⬆ Adelante</button>
<button onclick="mover('ATRAS')">⬇ Atrás</button>
<button onclick="mover('DERECHA')">➡ Derecha</button>
<button onclick="mover('IZQUIERDA')">⬅ Izquierda</button>
<button onclick="mover('STOP')">⏹ Stop</button>

</div>

<!-- SERIAL -->

<div id="serial">

Modo:

<select id="modo">
    <option value="SIM">Simulado</option>
    <option value="SERIAL">Serial Real</option>
</select>

<button onclick="conectar()">Conectar USB</button>

</div>

<div id="msg">Listo</div>

<!-- ================= JS ================= -->

<script>

let port;
let writer;

/* LED */

function led(id,v){

    document.getElementById(id).style.background =
    (v=="1")?"lime":"gray";
}

/* Flechas */

function flecha(id,v){

    let f="■";

    if(v=="10") f="▲";
    if(v=="01") f="▼";

    document.getElementById(id).innerText=f;
}

/* Movimiento */

function texto(a,b){

    if(a=="10" && b=="10") return "⬆ ADELANTE";
    if(a=="01" && b=="01") return "⬇ ATRÁS";
    if(a=="10" && b=="00") return "➡ DERECHA";
    if(a=="00" && b=="10") return "⬅ IZQUIERDA";
    if(a=="00" && b=="00") return "⏹ STOP";

    return "↕ MIXTO";
}

/* Actualizar UI */

function actualizar(a,b){

    led("A1",a[0]);
    led("A2",a[1]);
    led("B1",b[0]);
    led("B2",b[1]);

    flecha("fA",a);
    flecha("fB",b);

    document.getElementById("msg").innerText=
    texto(a,b);
}

/* Botones */

async function mover(m){

    let a,b,c;

    if(m=="ADELANTE"){a="10";b="10";c="F";}
    if(m=="ATRAS"){a="01";b="01";c="B";}
    if(m=="DERECHA"){a="10";b="00";c="R";}
    if(m=="IZQUIERDA"){a="00";b="10";c="L";}
    if(m=="STOP"){a="00";b="00";c="S";}

    document.getElementById("inA").value=a;
    document.getElementById("inB").value=b;

    actualizar(a,b);

    await enviarSerial(c);
}

/* Simular */

function simular(){

    let a=inA.value;
    let b=inB.value;

    if(!["00","01","10"].includes(a) ||
       !["00","01","10"].includes(b)){

        msg.innerText="Error: 00 01 10";
        return;
    }

    actualizar(a,b);
}

/* SERIAL REAL */

async function conectar(){

    if(!("serial" in navigator)){
        alert("Tu navegador no soporta WebSerial");
        return;
    }

    try{

        port = await navigator.serial.requestPort();
        await port.open({ baudRate:9600 });

        writer = port.writable.getWriter();

        msg.innerText="Conectado al Arduino";

    }catch(e){

        msg.innerText="Error de conexión";
    }
}

/* Enviar */

async function enviarSerial(c){

    if(modo.value!="SERIAL") return;

    if(!writer){
        msg.innerText="No conectado";
        return;
    }

    const data = new TextEncoder().encode(c);

    await writer.write(data);

}

</script>

</body>
</html>
