import tkinter as tk
from tkinter import *
from tkinter import ttk
from PIL import Image, ImageDraw, ImageFont, ImageTk
import serial
import serial.tools.list_ports
import os


# ===============================
# CREAR IMÁGENES DE FLECHAS
# ===============================

def crear_estado(nombre, flecha):

    w, h = 80, 80
    img = Image.new("RGB", (w, h), "white")
    d = ImageDraw.Draw(img)

    try:
        f = ImageFont.truetype("arial.ttf", 35)
    except:
        f = ImageFont.load_default()

    d.text((25,20), flecha, fill="blue", font=f)
    img.save(nombre)


def generar_estados():

    if not os.path.exists("imagenes"):
        os.mkdir("imagenes")

    crear_estado("imagenes/up.png", "↑")
    crear_estado("imagenes/down.png", "↓")
    crear_estado("imagenes/stop.png", " ")


# ===============================
# APP PRINCIPAL
# ===============================

class Simulador:

    def __init__(self, root):

        self.root = root
        self.root.title("Simulador Didáctico de Motores DC")
        self.root.geometry("980x780")
        self.root.configure(bg="#ECF3F9")

        generar_estados()

        self.serial = None


        # ================= TITULO =================

        Label(root,
              text="SIMULADOR DIDÁCTICO DE MOTORES",
              font=("Arial",24,"bold"),
              bg="#ECF3F9").pack(pady=10)


        # ================= PANEL PRINCIPAL =================

        panel = Frame(root,bg="#ECF3F9")
        panel.pack()


        # ================= CANVAS ROBOT =================

        self.canvas = Canvas(panel,
                             width=650,
                             height=280,
                             bg="white")
        self.canvas.grid(row=0,column=0,
                         columnspan=6,pady=10)

        self.canvas.create_rectangle(220,60,430,230,width=3)
        self.canvas.create_text(325,145,text="ROBOT",
                                font=("Arial",14,"bold"))


        # ================= MOTOR BASE (60%) =================

        if not os.path.exists("motor.png"):
            raise FileNotFoundError("Debe existir motor.png")

        img = Image.open("motor.png")
        w,h = img.size

        img = img.resize((int(w*0.6),int(h*0.6)),
                         Image.LANCZOS)

        self.motor_base = ImageTk.PhotoImage(img)


        # ================= ESTADOS =================

        self.estados = {
            "up": PhotoImage(file="imagenes/up.png"),
            "down": PhotoImage(file="imagenes/down.png"),
            "stop": PhotoImage(file="imagenes/stop.png")
        }


        # Motores
        self.motorA = self.canvas.create_image(
            190,150,image=self.motor_base)

        self.motorB = self.canvas.create_image(
            460,150,image=self.motor_base)

        # Flechas
        self.estadoA = self.canvas.create_image(
            190,70,image=self.estados["stop"])

        self.estadoB = self.canvas.create_image(
            460,70,image=self.estados["stop"])


        # ================= LEDs =================

        leds = Frame(panel,bg="#ECF3F9")
        leds.grid(row=1,column=0,
                  columnspan=6,pady=5)

        self.ca = Canvas(leds,
                         width=500,
                         height=90,
                         bg="#ECF3F9",
                         highlightthickness=0)

        self.ca.pack()

        self.leds = {
            "A1": self.ca.create_oval(60,20,90,50,fill="gray"),
            "A2": self.ca.create_oval(110,20,140,50,fill="gray"),
            "B1": self.ca.create_oval(300,20,330,50,fill="gray"),
            "B2": self.ca.create_oval(350,20,380,50,fill="gray")
        }

        self.ca.create_text(75,65,text="IN1")
        self.ca.create_text(125,65,text="IN2")
        self.ca.create_text(315,65,text="IN3")
        self.ca.create_text(365,65,text="IN4")


        # ================= ENTRADAS =================

        ent = Frame(panel,bg="#ECF3F9")
        ent.grid(row=2,column=0,columnspan=6,pady=10)

        Label(ent,text="Motor A (Izq):",
              font=("Arial",13),
              bg="#ECF3F9").grid(row=0,column=0)

        self.eA = Entry(ent,font=("Arial",15),
                        width=4,justify="center")
        self.eA.grid(row=0,column=1,padx=5)

        Label(ent,text="Motor B (Der):",
              font=("Arial",13),
              bg="#ECF3F9").grid(row=0,column=2)

        self.eB = Entry(ent,font=("Arial",15),
                        width=4,justify="center")
        self.eB.grid(row=0,column=3,padx=5)

        Button(ent,text="SIMULAR",
               command=self.simular,
               bg="#AED6F1").grid(row=0,column=4,padx=10)


        # ================= MENSAJE =================

        self.lbl = Label(panel,
                         text="Use: 10 / 01 / 00",
                         font=("Arial",18,"bold"),
                         bg="#ECF3F9")

        self.lbl.grid(row=3,column=0,columnspan=6,pady=10)


        # ================= SERIAL =================

        serial_panel = LabelFrame(
            root,
            text="CONFIGURACIÓN SERIAL",
            font=("Arial",13,"bold"),
            bg="#ECF3F9"
        )

        serial_panel.pack(fill="x",padx=15,pady=5)


        self.modo_var = StringVar(value="SIMULADO")


        Radiobutton(serial_panel,text="Simulado",
                    variable=self.modo_var,
                    value="SIMULADO",
                    bg="#ECF3F9").grid(row=0,column=0)

        Radiobutton(serial_panel,text="Serial",
                    variable=self.modo_var,
                    value="SERIAL",
                    bg="#ECF3F9").grid(row=0,column=1)


        Label(serial_panel,text="Puerto:",
              bg="#ECF3F9").grid(row=0,column=2)

        self.combo = ttk.Combobox(serial_panel,width=10)
        self.combo.grid(row=0,column=3,padx=5)

        Button(serial_panel,text="Actualizar",
               command=self.cargar_puertos)\
               .grid(row=0,column=4)

        Button(serial_panel,text="Conectar",
               command=self.conectar)\
               .grid(row=0,column=5,padx=5)


        # ================= ASIGNACIÓN =================

        asignar = LabelFrame(
            root,
            text="ASIGNAR CARACTERES",
            font=("Arial",13,"bold"),
            bg="#ECF3F9")

        asignar.pack(fill="x",padx=15,pady=10)


        self.cmd = {}

        datos = [
            ("Adelante","F"),
            ("Atrás","B"),
            ("Derecha","R"),
            ("Izquierda","L"),
            ("STOP","S")
        ]

        for i,(txt,defv) in enumerate(datos):

            Label(asignar,text=txt,
                  bg="#ECF3F9").grid(row=0,column=i*2)

            e = Entry(asignar,width=3,
                      justify="center")

            e.insert(0,defv)
            e.grid(row=0,column=i*2+1,padx=5)

            self.cmd[txt] = e


        # ================= BOTONES CONTROL =================

        btns = Frame(root,bg="#ECF3F9")
        btns.pack(pady=10)

        Button(btns,text="⬆ Adelante",
               width=12,
               command=lambda:self.enviar("ADELANTE"),
               bg="#ABEBC6").grid(row=0,column=0,padx=5)

        Button(btns,text="⬇ Atrás",
               width=12,
               command=lambda:self.enviar("ATRAS"),
               bg="#F5B7B1").grid(row=0,column=1,padx=5)

        Button(btns,text="➡ Derecha",
               width=12,
               command=lambda:self.enviar("DERECHA"),
               bg="#AED6F1").grid(row=0,column=2,padx=5)

        Button(btns,text="⬅ Izquierda",
               width=12,
               command=lambda:self.enviar("IZQUIERDA"),
               bg="#F9E79F").grid(row=0,column=3,padx=5)

        Button(btns,text="⏹ STOP",
               width=12,
               command=lambda:self.enviar("STOP"),
               bg="#D5DBDB").grid(row=0,column=4,padx=5)


        self.cargar_puertos()


    # ===============================
    # SERIAL
    # ===============================

    def cargar_puertos(self):

        ports = serial.tools.list_ports.comports()

        lista = [p.device for p in ports]

        self.combo["values"] = lista

        if lista:
            self.combo.current(0)


    def conectar(self):

        if self.modo_var.get()!="SERIAL":
            self.lbl.config(text="Modo SIMULADO activo")
            return

        try:
            p = self.combo.get()

            self.serial = serial.Serial(
                p,9600,timeout=1)

            self.lbl.config(text=f"Conectado a {p}")

        except:
            self.lbl.config(text="Error al conectar")


    # ===============================
    # ENVIAR COMANDOS
    # ===============================

    def enviar(self,mov):

        if mov=="ADELANTE":
            c = self.cmd["Adelante"].get()
            a,b = "10","10"

        elif mov=="ATRAS":
            c = self.cmd["Atrás"].get()
            a,b = "01","01"

        elif mov=="DERECHA":
            c = self.cmd["Derecha"].get()
            a,b = "10","00"

        elif mov=="IZQUIERDA":
            c = self.cmd["Izquierda"].get()
            a,b = "00","10"

        elif mov=="STOP":
            c = self.cmd["STOP"].get()
            a,b = "00","00"


        # Actualizar entradas
        self.eA.delete(0,END)
        self.eB.delete(0,END)
        self.eA.insert(0,a)
        self.eB.insert(0,b)


        # LEDs
        self.led("A1",a[0])
        self.led("A2",a[1])
        self.led("B1",b[0])
        self.led("B2",b[1])


        # Flechas
        self.estado("A",a)
        self.estado("B",b)


        mov_txt = self.movimiento(a,b)


        # Serial / Simulado
        if self.modo_var.get()=="SERIAL" and self.serial:
            self.serial.write(c.encode())
            self.lbl.config(text=f"Enviado: {c} | {mov_txt}")

        else:
            self.lbl.config(text=f"(Simulado) {c} | {mov_txt}")


    # ===============================
    # SIMULAR MANUAL
    # ===============================

    def simular(self):

        a = self.eA.get()
        b = self.eB.get()

        if a not in ["00","01","10"] or \
           b not in ["00","01","10"]:

            self.lbl.config(text="Error: 00 01 10")
            return


        self.led("A1",a[0])
        self.led("A2",a[1])
        self.led("B1",b[0])
        self.led("B2",b[1])


        self.estado("A",a)
        self.estado("B",b)


        self.lbl.config(text=self.movimiento(a,b))


    # ===============================
    # ESTADO MOTOR
    # ===============================

    def estado(self,m,v):

        if v=="10":
            img="up"
        elif v=="01":
            img="down"
        else:
            img="stop"

        if m=="A":
            self.canvas.itemconfig(
                self.estadoA,
                image=self.estados[img])

        else:
            self.canvas.itemconfig(
                self.estadoB,
                image=self.estados[img])


    # ===============================
    # LED
    # ===============================

    def led(self,l,v):

        if v=="1":
            self.ca.itemconfig(self.leds[l],fill="lime")
        else:
            self.ca.itemconfig(self.leds[l],fill="gray")


    # ===============================
    # MOVIMIENTO GENERAL
    # ===============================

    def movimiento(self,a,b):

        if a=="10" and b=="10":
            return "⬆ ADELANTE"

        if a=="01" and b=="01":
            return "⬇ ATRÁS"

        if a=="10" and b=="00":
            return "➡ DERECHA"

        if a=="00" and b=="10":
            return "⬅ IZQUIERDA"

        if a=="00" and b=="00":
            return "⏹ STOP"

        return "↕ MIXTO"



# ===============================
# MAIN
# ===============================

if __name__=="__main__":

    root = tk.Tk()
    app = Simulador(root)
    root.mainloop()
