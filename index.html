<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Radar Robot Serial</title>

<style>

body{
    background:#050d1a;
    color:white;
    font-family:Arial;
    text-align:center;
}

h1{ color:#00ffcc; }

/* MAPA */

#zona{
    width:800px;
    height:450px;
    margin:auto;
    background:#081828;
    border:3px solid cyan;
    position:relative;
    overflow:hidden;
}

/* ROBOT */

#robot{
    width:60px;
    height:80px;
    background:#333;
    position:absolute;
    left:370px;
    top:330px;
    border:2px solid #00ffcc;
    border-radius:10px;
}

#head{
    width:40px;
    height:20px;
    background:#111;
    position:absolute;
    top:-22px;
    left:10px;
    border-radius:5px;
}

/* SENSOR */

#sensor{
    width:6px;
    height:6px;
    background:lime;
    position:absolute;
    top:-5px;
    left:27px;
    border-radius:50%;
}

#beam{
    position:absolute;
    width:3px;
    height:200px;
    background:lime;
    top:-200px;
    left:28px;
    transform-origin:bottom center;
}

/* OBSTACULOS */

.obs{
    width:40px;
    height:40px;
    background:#b30000;
    position:absolute;
    border-radius:5px;
}

/* RADAR */

#radar{
    width:300px;
    height:300px;
    margin:20px auto;
    background:#02131f;
    border-radius:50%;
    border:3px solid #00ffcc;
    position:relative;
    overflow:hidden;
}

#scan{
    width:3px;
    height:150px;
    background:lime;
    position:absolute;
    bottom:150px;
    left:148px;
    transform-origin:bottom center;
}

.punto{
    width:6px;
    height:6px;
    background:red;
    border-radius:50%;
    position:absolute;
}

/* PANEL */

#panel{
    width:800px;
    margin:auto;
    display:flex;
    justify-content:space-around;
}

.box{
    border:1px solid cyan;
    padding:10px;
    width:200px;
}

button{
    padding:6px 12px;
    background:#00ffcc;
    border:none;
    border-radius:4px;
    cursor:pointer;
}

</style>
</head>

<body>

<h1>üì° ROBOT CON RADAR SERIAL</h1>

<!-- MAPA -->

<div id="zona">

<div id="robot">

<div id="head"></div>
<div id="sensor"></div>
<div id="beam"></div>

</div>

<!-- Obstaculos -->
<div class="obs" style="left:150px;top:100px"></div>
<div class="obs" style="left:600px;top:150px"></div>
<div class="obs" style="left:300px;top:220px"></div>
<div class="obs" style="left:500px;top:70px"></div>

</div>

<!-- RADAR -->

<h2>RADAR</h2>

<div id="radar">
    <div id="scan"></div>
</div>

<!-- PANEL -->

<div id="panel">

<div class="box">
<h3>Control</h3>
<button onclick="startRadar()">‚ñ∂ Iniciar</button><br><br>
<button onclick="stopRadar()">‚èπ Detener</button>
</div>

<div class="box">
<h3>Datos Serial</h3>
<p>√Ångulo:</p>
<h2 id="ang">0¬∞</h2>
<p>Distancia:</p>
<h2 id="dist">0 cm</h2>
</div>

<div class="box">
<h3>Estado</h3>
<p id="estado">Listo</p>
</div>

<div class="box">
<h3>Puerto</h3>
<button onclick="conectar()">üîå Conectar</button>
<p id="serial">No conectado</p>
</div>

</div>

<script>

/* SERIAL */
let port;
let writer;
let conectado=false;

async function conectar(){

    try{
        port = await navigator.serial.requestPort();
        await port.open({ baudRate:9600 });
        writer = port.writable.getWriter();
        conectado=true;
        serial.innerText="Conectado";
    }
    catch(e){ alert("Error Serial"); }
}

async function enviar(txt){
    if(!conectado) return;
    let data=new TextEncoder().encode(txt);
    await writer.write(data);
}

/* RADAR */

let angle=0;
let timer=null;

const scan=document.getElementById("scan");
const beam=document.getElementById("beam");
const radar=document.getElementById("radar");

function startRadar(){

    if(timer) return;

    estado.innerText="Escaneando";

    timer=setInterval(()=>{

        angle+=2;
        if(angle>180) angle=0;

        scan.style.transform=`rotate(${angle}deg)`;
        beam.style.transform=`rotate(${angle}deg)`;

        let d=medir(angle);

        ang.innerText=angle+"¬∞";
        dist.innerText=d+" cm";

        enviar(angle+","+d+"\n");

        pintarRadar(angle,d);

    },50);
}

function stopRadar(){

    clearInterval(timer);
    timer=null;
    estado.innerText="Detenido";
}

/* MEDICION */

function medir(a){

    let min=200;
    let obs=document.querySelectorAll(".obs");

    let rad=a*Math.PI/180;

    let ox=400;
    let oy=370;

    obs.forEach(o=>{

        let x=o.offsetLeft+20;
        let y=o.offsetTop+20;

        let dx=x-ox;
        let dy=oy-y;

        let ang=Math.atan2(dx,dy)*180/Math.PI;

        if(Math.abs(ang-a)<4){

            let d=Math.sqrt(dx*dx+dy*dy);
            if(d<min) min=d;
        }
    });

    return Math.round(min);
}

/* RADAR PLOT */

function pintarRadar(a,d){

    let r=150;
    let rad=a*Math.PI/180;

    let x=150 + (d/200*r)*Math.sin(rad);
    let y=150 - (d/200*r)*Math.cos(rad);

    let p=document.createElement("div");
    p.className="punto";
    p.style.left=x+"px";
    p.style.top=y+"px";

    radar.appendChild(p);

    setTimeout(()=>p.remove(),1000);
}

</script>

</body>
</html>
